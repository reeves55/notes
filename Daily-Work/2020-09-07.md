# 2020-09-07

buling：https://my.oschina.net/u/4138213/blog/4542065





业务逻辑

如何判断当前有哪些广告曝光的计划❓

用户浏览着浏览着，哪个位置可以放广告是怎么确定的



什么是品牌广告，什么是效果广告❓

品牌投放有哪些形式（Booking，CPT，GD，PDB，闪屏）

GD（Guaranteed Delivery）：广告主在投放广告时已经向媒体确认投放一定量广告，并且媒体已经确认会播放这些广告，并且在广告投放前已经约定好广告的价格和投放量，可以保证曝光量

PDB（Programmatic Direct Buying）：固定广告位，固定的价格，当有曝光机会时，广告主可以有选择地挑选流量，无需竞价



效果投放有哪些形式（CPC，CPM，CPA，ADX ，起飞）❓

ADX（Ad Exchange）：广告交易平台，当有曝光流量的时候，给各个DSP（需求方平台）发送曝光的相关信息，由各个DSP决定是否参与此次曝光的竞价，以及出价，然后ADX根据各个DSP的出价，选出此次曝光的广告内容，进行曝光。

<img src="https://5b0988e595225.cdn.sohucs.com/images/20170715/ad33448439044ae89f7f389cbcf1474f.png" alt="img" style="zoom:67%;" />





效果投放都是实时竞价吗❓

竞价广告，在有一个可放置的广告位出现时，开启竞价，竞价期间，广告主会根据此次曝光的用户质量进行评估，决定是否参与竞价，以及出价价格，出价较高的广告主可获得优先展示资格

为的是提升广告曝光效果，



运营管理要管理哪些内容❓（实验平台是干嘛的，）









## 术语



```ECPM```（effective cost per mile）：每一千次展示可以获得的广告收入

```CTR```（Click-Through-Rate）：点击通过率，指网络广告的实际点击次数 / 广告的展现量







## 广告计费方式



### CPT（Cost Per Time）

解释：按时长计费

好处：广告位置好，视觉展现效果好，比如App启动闪屏，吸睛

缺点：太贵，没有用户筛选度



### CPM（Cost Per Mille）

解释：千人展现成本，按照每千次曝光计费

好处：可以向指定用户群投放，投放精度高



### CPC（Cost Per Click）

解释：每次点击计费，对于广告主来说，相对于CPM，肯定更喜欢这个，但是这个肯定价格也是更高的，需要广告主去衡量支出和收获，对于不同的广告产品，应该也是需要考虑究竟是用户“看到就行”，还是“点了才有效果”，来决定采用哪种计费方式



![img](https://oscimg.oschina.net/oscnet/da5f282a-9f9d-4293-85d0-63014f3584ab.png)



其中，PV表示系统的访问量，PVR和ASN表示广告的填充率，CTR表示广告的点击率，ACP表示广告的平均点击价格。上述各个指标都可以通过一系列的广告策略来提升。 比如填充率可通过开发更多的广告主来实现， CTR可通过AI算法做到精准投放来提升， ACP可通过精准流量溢价或者提升广告主ROI来完成。掌握上面这个收入分解公式，对于理解广告业务至关重要，任何业务上的动作几乎都能关联到这个公式的某个指标上。



### CPA（Cost Pre Action）

解释：按照广告目标行为计费



## 广告系统架构



### 自营的竞价广告网络

依靠自身流量，并自行开发运营配套的广告系统，运作流程如下：

<img src="https://oscimg.oschina.net/oscnet/f9d8e6cd-5ff8-4efc-86ef-f03a101211f2.jpg" alt="img" style="zoom: 67%;" />



### 广告主

广告主先通过投放平台发布广告，可设置一系列的定向条件，比如投放城市、投放时间段、人群标签、出价等。





### 广告库

投放动作完成后，广告会被存放到广告库、同时进入索引库，以便能被广告检索引擎召回。广告库当中需要存储广告的素材，

使用 MySQL存储



### 广告索引库

```数据量大```





### 广告引擎

```对接C端```，```流量大```，```实时响应```，```业务逻辑复杂```

C端请求过来后，广告引擎会完成召回、算法策略、竞价排序等一系列的逻辑，最终筛选出Top N个广告，实现广告的千人千面。





### 广告计费

```安全性```，```可用性```，```准确性```

用户点击广告后，会触发广告扣费流程，这时候平台才算真正获得收益。





<img src="https://oscimg.oschina.net/oscnet/42bde862-c11b-4e83-b744-fa0fd640d163.png" alt="img" style="zoom:67%;" />



### 广告投放系统

给广告主使用，主要功能：管理广告素材，广告投放策略，费用查询余额管理，数据统计



### 广告运营后台

内部运营使用，主要功能：广告位管理（在哪里能放广告，放什么形式的广告），广告策略管理，



### 广告检索平台

从广告索引库当中检索某个位置匹配的广告，承接C端的高并发请求，负责从海量广告库中筛选出几个或者几十个广告，实时性要求高，这个平台通常由多个微服务组成



### AB实验平台

广告业务的稳定器，任何广告策略上的调整均可以通过此平台进行灰度实验，观察收入指标的变化



### 广告计费平台

面向C端，负责实时扣费，和收入直接挂钩，可用性要求高



### 账务管理中心

广告业务中的财务系统，统管金额相关的业务，包括充值、冻结、扣费等



### 大数据平台

整个广告系统的底盘，需要聚合各种异构数据源，完成离线和实时数据分析和统计，产出业务报表，生产模型特征等





## 存储系统



![img](https://oscimg.oschina.net/oscnet/45bb302e-9761-45b6-8897-b1f5d323cdb6.png)



### OLTP场景

包括广告库、创意库、会员库、广告产品库、广告策略库等，这些都存储在MySQL中，数据规模较大的广告库和创意库，按照广告主ID Hash做分库分表



### OLAP场景

涉及到非常多的报表，聚合维度多，单表的记录数可能达到百亿级别，底层采用HDFS和HBase存储





### 索引数据

面向广告检索场景的索引数据，包括正排索引和倒排索引，采用Redis和ES来存储



<img src="https://oscimg.oschina.net/oscnet/091cd836-f4d5-4523-8d58-2e941db11ca5.png" alt="img" style="zoom:67%;" />



广告投放完成后，首先会存储在MySQL数据库中，接下来需要把广告实时传输到检索系统中，完成正排索引以及倒排索引的更新

* 各个业务系统在推广、余额等信息变更时，发MQ消息，索引更新服务订阅MQ来感知变化，完成增量同步

* 变更的消息体中，不传递实际变更的字段，仅通知有变化的广告ID，索引更新服务实时读取最新数据完成更新，这样可以有效的解决消息乱序引起的数据不一致问题
* 当更新索引的并发达到一定量级后，可通过合并相同广告的变更、或者将倒排和正排更新分离的方式来提升整体的更新速度



## 数据源系统

```投放系统```，```运营系统```







## 检索系统

```正排索引```，```倒排索引```，```计算模型```，```实时处理```

广告检索平台负责承接C端的流量请求，从海量广告库中筛选出最合适的前N个广告，并在几十毫秒内返回结果，它是一个多级筛选和排序的过程。

<img src="https://oscimg.oschina.net/oscnet/a8c73054-e4fc-4064-ac9c-b793d78c56d4.png" alt="img" style="zoom:67%;" />



**性能设计是检索平台的重点，通常有以下手段：**

- 做好服务分层，各层均可水平扩展。
- 采用Redis缓存，避免高并发请求直接打到数据库，缓存可按业务规划多套，进行分流。
- 采用多线程并行化某些子流程，比如多路召回逻辑、多模型打分逻辑。
- 热点数据进行本地缓存，比如广告位的配置信息以及策略配置信息，在服务启动时就可以预加载到本地，然后定时进行同步。
- 非核心流程设置超时熔断走降级逻辑，比如溢价策略（不溢价只是少赚了，不影响广告召回）。
- 和主流程无关的逻辑异步执行，比如扣费信息缓存、召回结果缓存等。
- 精简RPC返回结果或者Redis缓存对象的结构，去掉不必要的字段，减少IO数据包大小。
- GC优化，包括JVM堆内存的设置、垃圾收集器的选择、GC频次优化和GC耗时优化



## 计费系统

```支持多种计费方式```，```反作弊```，```余额撞线处理```，```对账```，```幂等```

计费系统需要支持多种计费方式，反作弊、余额撞线处理、扣费订单的摊销和对账等功能，计费平台的特点是：并发高、数据量大、同时可用性要求高，需要做到不少扣，不重复扣。下面以CPC实时点击扣费为例，详细说下技术方案。



<img src="https://oscimg.oschina.net/oscnet/f324681f-43bc-4617-b6a9-faf7ec5cbb67.png" alt="img" style="zoom:67%;" />



另外，每次有效点击都需要生成1条扣费订单，面临大数据量的存储问题。目前我们采用的是MySQL分库分表，后期会考虑使用HBase等分布式存储。另外，订单和账务系统之间的数据一致性，采用大数据平台做天级别的增量抽取，通过Hive任务完成对账和监控。





## 统计系统




<img src="https://oscimg.oschina.net/oscnet/a06209f7-20ad-4129-962b-a67663af5476.png" alt="img" style="zoom:67%;" />



- **源数据层**：对应各种源数据，包括HDFS中实时采集的前后端日志，增量或者全量同步的MySQL业务数据表。
- **数据仓库层**：包含维度表和事实表，通常是对源数据进行清洗后的数据宽表，比如行为日志表、推广宽表、用户宽表等。
- **数据集市层**：对数据进行轻粒度的汇总表，比如广告效果表、用户行为的全链路表、用户群分析表等。
- **数据应用层**：上层应用场景直接使用的数据表，包括多维分析生成的各种收入报表、Spark任务产出的算法模型特征和画像数据等。



聚合维度多， 需要分时、分广告位、分推广等几十个维度； 单表最大达到百亿级别；支持时间范围的实时查询。这部分由公司的大数据部门维护，采用了开源的技术方案，离线部分使用Kylin，数据存储在HBase中；实时部分使用Flink和Spark Streaming，数据存储在Druid中。





## 未完待续

广告系统的稳定性保障、广告策略的可扩展性设计、RTB实时竞价的系统架构