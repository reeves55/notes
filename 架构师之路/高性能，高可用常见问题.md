# 高性能，高可用常见问题



## 1. 如何保证数据库和缓存数据的一致性❓

首先需要明白的是，使用缓存就相意味着原始数据服务和缓存服务构成了一个分布式系统，分布式系统就必须满足CAP原理，又由于分布式架构中，不同系统通过网络通信进行交互，难免会出现分区，也就是 <span style="color:red">由于网络延迟或者断开导致子系统状态（数据）不一致</span>，如果一定要保证两者的一致性，那么两者数据从非一致性状态过渡到一致性状态期间，系统无法提供服务，牺牲掉一部分可用性。如果想保证可用性，就意味着数据服务可能提供不一致数据。

⚠️ 以下方案都是在基于可以容忍一段时间数据不一致的前提下的解决方案

<img src="https://tuchuang-1256253537.cos.ap-shanghai.myqcloud.com/img/一致性.jpg" alt="一致性" style="zoom:53%;float:left" />



> 方案1：先写数据库，后删除缓存（推荐）

写数据库会造成数据库中的数据和缓存不一致，删除缓存则是为了让两个数据副本同步，删除怎么能做到数据同步呢，这和缓存的使用策略有关，详解下图，我们在使用缓存的时候，如果读缓存没有命中，则会从数据库中加载最新的数据到缓存里，这个时候就可以同步两者的数据了。

但这个方案有一个问题，如果缓存删除失败，也就是同步操作失败怎么办？还是会导致两者的不一致性

解决方案可以添加一个删除失败的重试策略，把重试任务添加到消息队列当中去

<img src="https://images.cnblogs.com/cnblogs_com/rjzheng/1202350/o_getkeyflow.png" alt="image" style="zoom:80%;float:left" />

















参考：

https://www.cnblogs.com/rjzheng/p/9041659.html